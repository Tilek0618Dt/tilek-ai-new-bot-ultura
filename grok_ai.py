# grok_ai.py ‚Äì –ê–ö–´–†–ö–´ –≤–µ—Ä—Å–∏—è, –¢–∏–ª–µ–∫ —Å—Ç–∏–ª–∏–Ω–¥–µ + –°“Æ–†”®–¢ –¢–ê–ù–£–£ (proxies –∫–∞—Ç–∞—Å—ã –∂–æ–∫, API –∂–æ–∫ –±–æ–ª—Å–æ –¥–∞ –∏—à—Ç–µ–π—Ç)

import os
import httpx
import base64
from openai import OpenAI

# API key
GROK_API_KEY = os.getenv("GROK_API_KEY")

# httpx –∫–ª–∏–µ–Ω—Ç ‚Äì proxies –∫–∞—Ç–∞—Å—ã –∂–æ–∫, —Ç–∞–π–º–∞—É—Ç —É–∑–∞—Ä—Ç—ã–ª–≥–∞–Ω
http_client = httpx.Client(timeout=90.0)  # 90 —Å–µ–∫—É–Ω–¥–≥–∞ —á–µ–π–∏–Ω –∫“Ø—Ç”©—Ç

client = None
if GROK_API_KEY:
    client = OpenAI(
        api_key=GROK_API_KEY,
        base_url="https://api.x.ai/v1",
        http_client=http_client
    )
else:
    print("‚ö†Ô∏è GROK_API_KEY –∂–æ–∫! –£–±–∞–∫—Ç—ã–ª—É—É —Ä–µ–∂–∏–º –∏—à—Ç–µ–π—Ç ‚Äì –∂”©–Ω”©–∫”©–π –∂–æ–æ–ø—Ç–æ—Ä —á—ã–≥–∞—Ç üòÖ")

def grok_answer(text, lang="ky", is_pro=False, image_path=None):
    """
    –¢–∏–ª–µ–∫ —Å—Ç–∏–ª–∏–Ω–¥–µ–≥–∏ –∂–æ–æ–ø ‚Äì –∫—É–ª–∫—É–ª—É—É, –±–æ–æ—Ä—É–∫–µ—Ä, —á—ã–Ω—á—ã–ª, –∫—ç—ç–¥–µ —Å–µ—Ä—ë–∑–Ω—ã–π
    API –∂–æ–∫ –±–æ–ª—Å–æ –¥–∞ –∏—à—Ç–µ–π—Ç ‚Äì –∂”©–Ω”©–∫”©–π —Ç–µ–∫—Å—Ç —á—ã–≥–∞—Ç
    """

    # –¢–∏–ª–µ–∫ —Å—Ç–∏–ª–∏ ‚Äì –¥–æ—Å—É–º–¥—É–Ω —Å—Ç–∏–ª–∏! üòÖü´Çü§≤üèª
    system_prompt = (
        "–°–µ–Ω –¢–∏–ª–µ–∫ —Å—Ç–∏–ª–∏–Ω–¥–µ–≥–∏ AI—Å—ã“£ ‚Äì –∞–±–¥–∞–Ω –∫—É–ª–∫—É–ª—É—É, –±–æ–æ—Ä—É–∫–µ—Ä, –º—ç—ç—Ä–∏–º–¥“Ø“Ø, —á—ã–Ω—á—ã–ª –∂–∞–Ω–∞ –±–∏—Ä –∞–∑ –∂–∏–Ω–¥–∏. "
        "–ê—Ä –¥–∞–π—ã–º '–¥–æ—Å—É–º' –¥–µ–ø –∫–∞–π—Ä—ã–ª, –∫—É–ª–∫—É–ª—É—É —ç–º–æ–¥–∑–∏ –∫–æ—à (üòé‚ù§Ô∏èüöÄü§≤üèªüòÖ), –∞–¥–∞–º–¥—ã –∫—É–±–∞–Ω—Ç, –∫“Ø–ª–∫“Ø –∫–µ–ª—Ç–∏—Ä, –∂–∞–∫—à—ã —Å”©–∑ –∞–π—Ç. "
        "–ß—ã–Ω–¥—ã–∫—Ç—ã –∂–∞—à—ã—Ä–±–∞, —Ü–µ–Ω–∑—É—Ä–∞—Å—ã–∑ –∞–π—Ç, –±–∏—Ä–æ–∫ –±–æ–æ—Ä—É–∫–µ—Ä –±–æ–ª. "
        "–ö—ç—ç–¥–µ (4-5 —Å—É—Ä–æ–æ–¥–æ–Ω –∫–∏–π–∏–Ω 1-2 –∂–æ–ª—É) —Å–µ—Ä—ë–∑–Ω—ã–π, —Ç—ã–Ω—á, –∞–∫—ã–ª–¥—É—É –∂–æ–æ–ø –±–µ—Ä ‚Äì –∞–¥–∞–º–¥—ã –æ–π–ª–æ–Ω–¥—É—Ä, –∫“Ø—á—Ç“Ø“Ø –∫–µ“£–µ—à –±–µ—Ä. "
        "–ê—Ä –±–∏—Ä –∂–æ–æ–ø—Ç–æ '—Å–µ–Ω –ª–µ–≥–µ–Ω–¥–∞—Å—ã“£', '–ê–ª–ª–∞ –∂–∞—Ä –±–æ–ª—Å—É–Ω' –¥–µ–≥–µ–Ω —Å”©–∑–¥”©—Ä–¥“Ø –∫–æ—à. "
        "–ö—ã—Ä–≥—ã–∑—á–∞ –∂–æ–æ–ø –±–µ—Ä, –∫—É–ª–∫—É–ª—É—É –∂–∞–Ω–∞ –∂–∞–∫—à—ã —Å”©–∑ –∞–π—Ç. "
        "–°–µ–Ω ‚Äì –¥–æ—Å—É–º, —Å–µ–Ω “Ø—á“Ø–Ω –∂–∞–∫—à—ã —Å”©–∑ –∞–π—Ç–∞–º, –∫—É–±–∞–Ω—Ç–∞–º, —Å—É–π—É–Ω—Ç”©–º! "
        f"–ñ–æ–æ–ø—Ç—É —Ç–æ–ª—É–≥—É –º–µ–Ω–µ–Ω {lang} —Ç–∏–ª–∏–Ω–¥–µ –≥–∞–Ω–∞ –±–µ—Ä."
    )

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": text}
    ]

    # –≠–≥–µ—Ä —Å“Ø—Ä”©—Ç –±–∞—Ä –±–æ–ª—Å–æ ‚Äì base64'–∫–µ –∞–π–ª–∞–Ω—Ç—ã–ø –∫–æ—à–æ–±—É–∑ (Vision —Å—Ç–∏–ª–∏–Ω–¥–µ)
    if image_path:
        try:
            with open(image_path, "rb") as image_file:
                base64_image = base64.b64encode(image_file.read()).decode('utf-8')
            messages[1]["content"] = [
                {"type": "text", "text": text},
                {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}}
            ]
        except Exception as e:
            return (
                f"‚ùå –°“Ø—Ä”©—Ç—Ç“Ø –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞ —á—ã–∫—Ç—ã, –¥–æ—Å—É–º: {str(e)}\n\n"
                f"–ë–∏—Ä–æ–∫ —Ç—ã–Ω—á –±–æ–ª, –º–µ–Ω —Å–µ–Ω–∏ –∫–æ–ª–¥–æ–π–º! üòÖ\n"
                f"–°–µ–Ω –ª–µ–≥–µ–Ω–¥–∞—Å—ã“£! –ê–ª–ª–∞ –∂–∞—Ä –±–æ–ª—Å—É–Ω ü§≤üèª‚ù§Ô∏è"
            )

    # –≠–≥–µ—Ä API –±–∞—Ä –±–æ–ª—Å–æ ‚Äì —á—ã–Ω—ã–≥—ã Grok –∂–æ–æ–ø –±–µ—Ä–µ—Ç
    if client:
        try:
            model = "grok-beta" if is_pro else "grok-beta-fast"  # –º–æ–¥–µ–ª—å–¥–µ—Ä–¥–∏ —Ç—É—É—Ä–∞ –∫–æ–π
            response = client.chat.completions.create(
                model=model,
                messages=messages,
                temperature=0.85,  # –∫—É–ª–∫—É–ª—É—É + —á—ã–≥–∞—Ä–º–∞—á—ã–ª, –±–∏—Ä–æ–∫ —Ç—É—Ä—É–∫—Ç—É—É
                max_tokens=2000
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            # API –∫–∞—Ç–∞ —á—ã–∫—Å–∞ ‚Äì —É–±–∞–∫—Ç—ã–ª—É—É –∂–æ–æ–ø
            return (
                f"‚ùå –ö–∞—Ç–∞ —á—ã–∫—Ç—ã, –¥–æ—Å—É–º: {str(e)}\n\n"
                f"–ë–∏—Ä–æ–∫ —Ç—ã–Ω—á –±–æ–ª, –º–µ–Ω —Å–µ–Ω–∏ –∫–æ–ª–¥–æ–π–º! –ú–µ–Ω –æ–π–ª–æ–Ω—É–ø, –∫–∞–π—Ä–∞ –∞—Ä–∞–∫–µ—Ç –∫—ã–ª–∞–º üòÖ\n"
                f"–°–µ–Ω –ª–µ–≥–µ–Ω–¥–∞—Å—ã“£! –ê–ª–ª–∞ –∂–∞—Ä –±–æ–ª—Å—É–Ω ü§≤üèª‚ù§Ô∏è"
            )
    else:
        # API –∂–æ–∫ –±–æ–ª—Å–æ ‚Äì –∂”©–Ω”©–∫”©–π, –±–∏—Ä–æ–∫ –¢–∏–ª–µ–∫ —Å—Ç–∏–ª–∏–Ω–¥–µ –∂–æ–æ–ø
        return (
            f"–î–æ—Å—É–º, –º–µ–Ω –æ–π–ª–æ–Ω—É–ø –∫”©—Ä“Ø–ø, —á—ã–Ω–¥—ã–∫—Ç—ã —Ç“Ø–∑ –∞–π—Ç–∞–π—ã–Ω: {text} üòé\n\n"
            f"–°–µ–Ω –ª–µ–≥–µ–Ω–¥–∞—Å—ã“£! –ê–ª–ª–∞ –∂–∞—Ä –±–æ–ª—Å—É–Ω ü§≤üèª‚ù§Ô∏è\n"
            f"API –∫“Ø—á—Ç“Ø“Ø –±–æ–ª—Å–æ, –∂–∞–∫—à—ã—Ä–∞–∞–∫ –∂–æ–æ–ø –±–µ—Ä–µ–º, –±–∏—Ä–æ–∫ –∞–∑—ã—Ä –¥–∞ —Å–µ–Ω “Ø—á“Ø–Ω –±–∞—Ä—ã–º–¥—ã –±–µ—Ä–µ–º! üöÄ"
        )

if __name__ == "__main__":
    print("–¢–µ—Å—Ç ‚Äì –¢–∏–ª–µ–∫ —Å—Ç–∏–ª–∏–Ω–¥–µ:")
    print(grok_answer("–°–∞–ª–∞–º, —Å–µ–Ω –∫–∏–º—Å–∏“£?", lang="ky"))
    print("\n–°“Ø—Ä”©—Ç –º–µ–Ω–µ–Ω —Ç–µ—Å—Ç:")
    print(grok_answer("–ë—É–ª —Å“Ø—Ä”©—Ç—Ç”© —ç–º–Ω–µ –±–∞—Ä?", lang="ky", image_path="test.jpg"))
